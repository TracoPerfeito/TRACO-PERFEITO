<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
   <link rel="shortcut icon" href="imagens/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="css/notificacao.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
   <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
   
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet"> 
   
  
  
  <title>Notificações</title>


  
</head>
<body>

  
<% if (status_usuario === 'pendente') { %>
    <%- include('../partials/aviso-pendente') %>
    
<% } %>
  


    

   <% if (tipo_usuario === 'profissional') { %>
  <%- include('../partials/menu-logado', { tipo_usuario: tipo_usuario }) %>
<% } else if (tipo_usuario === 'comum') { %>
  <%- include('../partials/menu-c-c', { tipo_usuario: tipo_usuario }) %>
<% } else { %>
  <%- include('../partials/menu', { tipo_usuario: tipo_usuario }) %>
<% } %>

   <section class="botao-de-voltar">   
    <button class="btn-voltar" onclick="voltarPagina()"> <ion-icon name="arrow-back-outline" id="seta"></ion-icon></button>
    <p class="lado-botao"> Perfil de Jaqueline Maria</p>
</section>

  <section class="container">
  <section class="lista-notificacoes">
    <% if (notificacoes.length === 0) { %>
      <p class="empty-message">Você não tem notificações no momento.</p>
      <img src="/imagens/sem-notificacoes.png" alt="Sem notificações" class="empty-img">
    <% } else { %>
      <% notificacoes.forEach((n, index) => { %>
        <section class="notificacao <%= n.STATUS === 'NAO_LIDA' ? 'highlight' : '' %>" onclick="abrirMensagem(<%= index %>)">
          <h4><%= n.TITULO_NOTIFICACAO %></h4>
          <small><%= new Date(n.DATA_CRIACAO).toLocaleString('pt-BR') %></small>
        </section>
      <% }) %>
    <% } %>
  </section>

  <section class="conteudo-mensagem">
    <section class="top-bar">
      <button class="btn-lida" onclick="marcarComoLida()">Marcar como lida</button>
    </section>
    <section class="mensagem-box" id="mensagemContent">
      <% if (notificacoes.length > 0) { %>
        <h2><%= notificacoes[0].TITULO_NOTIFICACAO %></h2>
        <time><%= new Date(notificacoes[0].DATA_CRIACAO).toLocaleString('pt-BR') %></time>
        <p><%= notificacoes[0].CONTEUDO_NOTIFICACAO %></p>
      <% } %>
    </section>
  </section>
</section>

<script>
  const mensagens = <%- JSON.stringify(notificacoes) %>;

  function abrirMensagem(index) {
    const msg = mensagens[index];
    document.getElementById("mensagemContent").innerHTML = `
      <h2>${msg.TITULO_NOTIFICACAO}</h2>
      <time>${new Date(msg.DATA_CRIACAO).toLocaleString('pt-BR')}</time>
      <p>${msg.CONTEUDO_NOTIFICACAO}</p>
    `;

    // Marcar notificação como lida via fetch
    if (msg.STATUS === 'NAO_LIDA') {
      fetch('/notificacao/marcar-como-lida/' + msg.ID_NOTIFICACAO, { method: 'PUT' })
        .then(() => { msg.STATUS = 'LIDA'; }) 
        .catch(err => console.error(err));
    }
  }

  function marcarComoLida() {
    const index = mensagens.findIndex(m => m.STATUS === 'NAO_LIDA');
    if(index !== -1) abrirMensagem(index); // marca a primeira não lida
  }

  // Exibir primeira mensagem ao abrir
  window.onload = () => {
    if (mensagens.length > 0) abrirMensagem(0);
  }
</script>

   <script src="js/mobile-navbar.js"></script>
 <script src="js/voltar.js"></script>
</body>
</html>
